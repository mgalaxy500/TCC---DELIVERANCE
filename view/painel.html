<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Controle</title>
  <link rel="stylesheet" href="CSS/painel.css" />
</head>

<body>
  <div class="faixa-topo"></div>

  <div class="univap-logo">
    <img src="Imagens/Univap[Negativo].png" alt="Logo Univap" />
  </div>

  <div class="faixa-base"></div>

  <div class="conteudo-principal">
    <!-- PAINEL DE CONTROLE (LADO ESQUERDO) -->
    <div class="painel-controle">

      <!-- FILTROS -->
      <div class="filtros-container">
        <input type="text" id="filtroNome" class="filtro-input" placeholder="Filtrar por nome do aluno..." />

        <select id="filtroTurma" class="filtro-select">
          <option value="">Filtrar por turma...</option>
          <option value="1A">1A</option>
          <option value="2B">2B</option>
          <option value="3A">3A</option>
        </select>

        <select id="filtroStatus" class="filtro-select">
          <option value="">Filtrar por status...</option>
          <option value="pendente">Pendente</option>
          <option value="aprovado">Aprovado</option>
          <option value="reprovado">Reprovado</option>
        </select>
      </div>

      <!-- DADOS DO USUÁRIO -->
      <div id="div_dados_usuario"></div>

      <!-- SEÇÃO GERENCIAR -->
      <div class="secao-gerenciar">
        <div class="titulo-gerenciar">Gerenciar</div>
        <div class="botoes-navegacao">
          <a href="alunos.html" class="botao-navegacao">Alunos</a>
          <a href="professor.html" class="botao-navegacao">Professores</a>
          <a href="disciplina.html" class="botao-navegacao">Disciplinas</a>
          <a href="desenvolvedor.html" class="botao-navegacao">Desenvolvedores</a>
          <a href="requisicao.html" class="botao-navegacao">Requisições</a>
        </div>
      </div>

      <!-- SEÇÃO GERAR -->
      <div class="secao-gerar">
        <div class="titulo-gerenciar">Gerar</div>
        <div class="botoes-acao">
          <a href="#" class="botao-acao" onclick="gerarPlanilha()">Planilha Excel</a>
        </div>
      </div>
    </div>

    <!-- LISTA DE REQUERIMENTOS (LADO DIREITO) -->
    <div class="requerimentos-lista">
      <div class="lista-titulo">
        <h2>Requerimentos</h2>
      </div>

      <div class="requerimentos-container"></div>
    </div>
  <!-- ================== FILTRO E STATUS APROVADO/REPROVADO ================== -->
  <script>

    let JSON_PROFESSORES = [];
    let JSON_DISCIPLINAS = [];

    // Busca professores
    function get_professores() {
      const dadosUsuario = localStorage.getItem("dados");
      const objUsuario = JSON.parse(dadosUsuario);
      return fetch("http://localhost:5050/professor/", {
        method: "GET",
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + objUsuario.token
        }
      })
      .then(res => res.json())
      .then(data => {
        JSON_PROFESSORES = data.professors || [];
      });
    }

    // Busca disciplinas
    function get_disciplinas() {
      const dadosUsuario = localStorage.getItem("dados");
      const objUsuario = JSON.parse(dadosUsuario);
      return fetch("http://localhost:5050/disciplina", {
        method: "GET",
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + objUsuario.token
        }
      })
      .then(res => res.json())
      .then(data => {
        JSON_DISCIPLINAS = data.disciplinas || [];
      });
    }

    // Função para filtrar requerimentos
    function filtrarRequerimentos() {
      const filtroNome = document.getElementById('filtroNome').value.toLowerCase();
      const filtroTurma = document.getElementById('filtroTurma').value;
      const filtroStatus = document.getElementById('filtroStatus').value;
      const cards = document.querySelectorAll('.requerimento-card');

      cards.forEach(card => {
        const nome = card.dataset.nome.toLowerCase();
        const turma = card.dataset.turma;
        const status = card.dataset.status;

        const nomeMatch = nome.includes(filtroNome);
        const turmaMatch = !filtroTurma || turma === filtroTurma;
        const statusMatch = !filtroStatus || status === filtroStatus;

        if (nomeMatch && turmaMatch && statusMatch) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }

    

    // Event listeners para os filtros
    document.getElementById('filtroNome').addEventListener('input', filtrarRequerimentos);
    document.getElementById('filtroTurma').addEventListener('change', filtrarRequerimentos);
    document.getElementById('filtroStatus').addEventListener('change', filtrarRequerimentos);

    // Funções para aprovar e reprovar requerimentos
    function aprovarRequerimento(button) {
      const card = button.closest('.requerimento-card');
      const statusBadge = card.querySelector('.status-badge');
      const idRequisicao = card.dataset.id;

      const dadosUsuario = localStorage.getItem("dados");
      const objUsuario = JSON.parse(dadosUsuario);

      fetch(`http://localhost:5050/requisicao/${idRequisicao}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + objUsuario.token
        },
        body: JSON.stringify({
          requisicao: {
            statusRequisicao: 0 // aprovado
          }
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status) {
          card.dataset.status = 'aprovado';
          statusBadge.textContent = 'Aprovado';
          statusBadge.className = 'status-badge status-aprovado';
          alert('Requerimento aprovado com sucesso!');
        } else {
          alert('Erro ao aprovar requerimento!');
        }
      })
      .catch(() => alert('Erro ao aprovar requerimento!'));
    }

    function reprovarRequerimento(button) {
      const card = button.closest('.requerimento-card');
      const idRequisicao = card.dataset.id;

      const dadosUsuario = localStorage.getItem("dados");
      const objUsuario = JSON.parse(dadosUsuario);

      if (!confirm("Tem certeza que deseja reprovar (excluir) esta requisição?")) return;

      fetch(`http://localhost:5050/requisicao/${idRequisicao}`, {
        method: "DELETE",
        headers: {
          "Authorization": "Bearer " + objUsuario.token
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.status) {
          card.remove();
          alert('Requerimento reprovado e removido!');
        } else {
          alert('Erro ao reprovar requerimento!');
        }
      })
      .catch(() => alert('Erro ao reprovar requerimento!'));
    }

    // Função para gerar planilha Excel (simulada)
    function gerarPlanilha() {
      alert('Planilha Excel gerada com sucesso! (Funcionalidade simulada)');
    }
    
    // Obtem os dados do usuário do localStorage
    const dadosUsuario = localStorage.getItem("dados");
    const objUsuario = JSON.parse(dadosUsuario);

    // Exibe o e-mail do usuário no painel
    const div_dados_usuario = document.getElementById("div_dados_usuario");
    
    // div_dados_usuario.appendChild(document.createTextNode(`Bem-vindo, ${objUsuario.funcionario.emailFuncionario}`));
    
    // Cria o card usando os nomes reais
    function criarCardRequerimento(req) {
      const status = req.statusRequisicao == 1 ? 'pendente' :
                    req.statusRequisicao == 0 ? 'aprovado' : 'reprovado';
      const statusTexto = status.charAt(0).toUpperCase() + status.slice(1);

      // Busca nome do professor e disciplina pelos IDs
      let professor = JSON_PROFESSORES.find(p => p.idProfessor == req.professor_idProfessor);
      let nomeProfessor = professor ? professor.nomeProfessor : req.professor_idProfessor;

      let disciplina = JSON_DISCIPLINAS.find(d => d.idDisciplina == req.disciplina_idDisciplina);
      let nomeDisciplina = disciplina ? disciplina.nomeDisciplina : req.disciplina_idDisciplina;

      let dataProva = req.dataRequisicao;
      if (dataProva && dataProva.length >= 10) {
        dataProva = dataProva.split('T')[0].split('-').reverse().join('/');
      }

      return `
        <div class="requerimento-card" 
            data-id="${req.idRequisicao}" 
            data-nome="${req.aluno_matriculaAluno || ''}" 
            data-turma="${req.turmaAluno || ''}" 
            data-status="${status}">
          <p><strong>Nome:</strong> ${req.nomeAluno || ''}</p>
          <p><strong>Matrícula:</strong> ${req.aluno_matriculaAluno || ''}</p>
          <p><strong>Turma:</strong> ${req.turmaAluno || ''}</p>
          <p><strong>Professor:</strong> ${nomeProfessor || ''}</p>
          <p><strong>Disciplina:</strong> ${nomeDisciplina || ''}</p>
          <p><strong>Justificativa:</strong> ${req.justRequisicao || ''}</p>
          <p><strong>Data da Prova da Falta:</strong> ${dataProva || ''}</p>
          <p><strong>Semana:</strong> ${req.gNRequisicao || ''}</p>
          <p><strong>Modelo:</strong> ${req.modeloRequisicao || ''}</p>
          <div class="botoes-status">
            <button class="btn-aprovar" onclick="aprovarRequerimento(this)">Aprovar</button>
            <button class="btn-reprovar" onclick="reprovarRequerimento(this)">Reprovar</button>
          </div>
          <div class="status-badge status-${status}">${statusTexto}</div>
        </div>
      `;
    }

    // Busca tudo e carrega os cards
    function carregarRequisicoes() {
      const container = document.querySelector('.requerimentos-container');
      container.innerHTML = '<p style="color:#fff">Carregando...</p>';

      // Busca professores e disciplinas antes de buscar as requisições
      Promise.all([get_professores(), get_disciplinas()])
        .then(() => {
          const dadosUsuario = localStorage.getItem("dados");
          const objUsuario = JSON.parse(dadosUsuario);

          return fetch("http://localhost:5050/requisicao", {
            method: "GET",
            headers: {
              "Accept": "application/json",
              "Authorization": "Bearer " + objUsuario.token
            }
          });
        })
        .then(res => res.json())
        .then(data => {
          if (data.requisicaos && Array.isArray(data.requisicaos)) {
            if (data.requisicaos.length === 0) {
              container.innerHTML = '<p style="color:#fff">Nenhuma requisição encontrada.</p>';
            } else {
              container.innerHTML = data.requisicaos.map(criarCardRequerimento).join('');
            }
          } else {
            container.innerHTML = '<p style="color:#fff">Erro ao carregar requisições.</p>';
          }
        })
        .catch(() => {
          container.innerHTML = '<p style="color:#fff">Erro ao carregar requisições.</p>';
        });
    }

    window.addEventListener('DOMContentLoaded', carregarRequisicoes);
  </script>
</body>
</html>
