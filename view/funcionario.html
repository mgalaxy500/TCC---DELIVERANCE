<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Desenvolvedores</title>
  <link rel="stylesheet" href="CSS/funcionario.css">
</head>

<body>

  <div class="faixa-topo">
    <div class="univap-logo">
      <img src="Imagens/Univap[Negativo].png" alt="Logo Univap" />
    </div>
  </div>

  <div id="container">
    <h1>Cadastro de Funcion치rios</h1>

    <div class="form-container">
      <div class="caixas-texto">
        <input type="text" id="txtIdFuncionario" placeholder="ID" disabled>
      </div>
      <div class="caixas-texto">
        <input type="text" id="txtEmailFuncionario" placeholder="Email do Funcion치rio">
      </div>
      <div class="caixas-texto">
        <input type="password" id="txtSenhaFuncionario" placeholder="Senha do Funcion치rio">
      </div>

      <div class="button-container">
        <button id="btnCadastrar" class="enviar-button">Cadastrar</button>
      </div>
    </div>

    <div class="upload-button-container">
        <input type="file" id="arquivo" class="upload-button">
        <button id="btnUpload" class="upload-button" type="button">Enviar CSV</button>
    </div>
    
    <div id="divDados"></div>
  </div>

  <!-- ===== MODAL PARA MUDAR SENHA ===== -->
  <div id="modalAlterarSenha" class="modal">
    <div class="modal-content">
      <h2>Alterar Senha</h2>

      <label for="senhaAtual">Senha atual:</label>
      <input type="password" id="senhaAtual" placeholder="Digite sua senha atual">

      <label for="novaSenha">Nova senha:</label>
      <input type="password" id="novaSenha" placeholder="Digite sua nova senha">

      <div class="modal-buttons">
        <button id="btnConfirmarSenha" class="btn-confirmar">Confirmar</button>
        <button id="btnCancelarSenha" class="btn-cancelar">Cancelar</button>
      </div>
    </div>
  </div>
  <script>
    let JSON_FUNCIONARIOS = {};

    const dadosLocalStorage = localStorage.getItem("dados");
    const objUsuario = JSON.parse(dadosLocalStorage);

    const txtIFuncionario = document.getElementById("txtIdFuncionario");
    const txtEmailFuncionario = document.getElementById("txtEmailFuncionario");
    const txtSenhaFuncionario = document.getElementById("txtSenhaFuncionario");
    const btnCadastrar = document.getElementById("btnCadastrar");

    const divDados = document.getElementById("divDados");
    const tabela = document.createElement("table");
    const linha1 = document.createElement("tr");

    const td0 = document.createElement("th");
    const td1 = document.createElement("th");
    const td2 = document.createElement("th");
    const td3 = document.createElement("th");
    const td4 = document.createElement("th");
    const td5 = document.createElement("th");

    td0.appendChild(document.createTextNode("ID"));
    td1.appendChild(document.createTextNode("Email"));
    td2.appendChild(document.createTextNode("Selecionar"));
    td3.appendChild(document.createTextNode("Atualizar"));
    td4.appendChild(document.createTextNode("Excluir"));
    td5.appendChild(document.createTextNode("Alterar Senha"));

    divDados.appendChild(tabela);
    tabela.appendChild(linha1);

    linha1.appendChild(td0);
    linha1.appendChild(td1);
    linha1.appendChild(td2);
    linha1.appendChild(td3);
    linha1.appendChild(td4);
    linha1.appendChild(td5);

    btnCadastrar.onclick = function () {
      post_funcionarios();
    };

    get_funcionarios();

    function limparTabela() {
      var qtdLinas = 1;
      var totalLinhas = tabela.rows.length;
      for (let i = qtdLinas; i < totalLinhas; i++) {
        tabela.deleteRow(qtdLinas);
      }
    }

    function delete_funcionario(idFuncionario) {
      const URI = "http://localhost:5050/funcionario/" + idFuncionario;
      fetch(URI, {
        method: "DELETE",
        headers: {
          'Authorization': 'Bearer ' + objUsuario.token
        }
      })
      .then((resposta) => {
        return resposta.json()
      .then(dados => {
        if (dados.status) {
          get_funcionarios();
        } else {
          alert("Falha ao excluir funcion치rio: " + (dados.msg || ""));
        }
      });
      }).catch(erro => {
        console.log(erro);
      });
    }

    function update_funcionario() {
      const id = txtIFuncionario.value;
      const emailFuncionario = txtEmailFuncionario.value;
      const senhaFuncionario = txtSenhaFuncionario.value;

      if (emailFuncionario == "") {
        alert("O email n칚o pode ser vazio");
        return;
      }

      const corpo = {
        "funcionario": {
          "emailFuncionario": emailFuncionario,
          "senhaFuncionario": senhaFuncionario,
        }
      };
      const URI = "http://localhost:5050/funcionario/" + id;
      fetch(URI, {
        method: "PUT",
        body: JSON.stringify(corpo),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + objUsuario.token
        }
      }).then((resposta) => {
        return resposta.text();
      }).then(respostaConvertida => {
          console.log(respostaConvertida);
        get_funcionarios();  // Atualiza a tabela ap칩s atualizar
        const objResposta = JSON.parse(respostaConvertida);
        if (objResposta.status == false) {
          alert(objResposta.msg);
        }
      }).catch(erro => {
        console.log(erro);
      });
    }

    btnUpload.onclick = function (event) {
        event.preventDefault(); // <-- Adicione esta linha
        const dados = new FormData();
        dados.append('variavelArquivo', arquivo.files[0]);

        const URI = "http://localhost:5050/funcionario/csv/";
        fetch(URI, {
            method: "POST",
            body: dados,
            headers: {
                'Authorization': 'Bearer ' + objUsuario.token
            }
        }).then((resposta) => {
            return resposta.text();
        }).then(respostaConvertida => {
            console.log(respostaConvertida);
            get_alunos();
            const resposta = JSON.parse(respostaConvertida);
            if (resposta.status == true) {
                alert("Funcionarios cadastrados com sucesso");
            }
        }).catch(erro => {
            console.log(erro);
        })
    }

    function construirTabela(JSON_FUNCIONARIOS, filtro) {
      limparTabela();

      for (let funcionario of JSON_FUNCIONARIOS) {
        const linha = document.createElement("tr");

        const td0 = document.createElement("td");
        const td1 = document.createElement("td");
        const td2 = document.createElement("td");
        const td3 = document.createElement("td");
        const td4 = document.createElement("td");
        const td5 = document.createElement("td");

        td0.textContent = funcionario.idFuncionario;

        // 游댳 Campo de e-mail edit치vel (como no outro c칩digo)
        const txtAlterar = document.createElement("input");
        txtAlterar.type = "text";
        txtAlterar.value = funcionario.emailFuncionario;
        txtAlterar.disabled = true; // s칩 habilita ao clicar em "Selecionar"
        td1.appendChild(txtAlterar);

        // 游댳 Bot칚o Selecionar
        const btnSelecionar = document.createElement("button");
        btnSelecionar.textContent = "Selecionar";
        btnSelecionar.onclick = () => {
          txtAlterar.disabled = false; // permite editar
          txtAlterar.focus();
        };
        td2.appendChild(btnSelecionar);

        // 游댳 Bot칚o Atualizar
        const btnAtualizar = document.createElement("button");
        btnAtualizar.textContent = "Atualizar";
        btnAtualizar.onclick = () => {
          const novoEmail = txtAlterar.value.trim();
          if (!novoEmail) {
            alert("O email n칚o pode ficar vazio!");
            return;
          }

          // Chama o PUT direto aqui
          const URI = `http://localhost:5050/funcionario/${funcionario.idFuncionario}`;
          const corpo = { funcionario: { emailFuncionario: novoEmail } };

          fetch(URI, {
            method: "PUT",
            body: JSON.stringify(corpo),
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + objUsuario.token
            }
          })
          .then(res => res.text())
          .then(respostaConvertida => {
            const obj = JSON.parse(respostaConvertida);
            if (obj.status === true) {
              alert("Funcion치rio atualizado com sucesso!");
              txtAlterar.disabled = true;
              get_funcionarios(); // atualiza a tabela
            } else {
              alert(obj.msg || "Erro ao atualizar funcion치rio.");
            }
          })
          .catch(erro => console.error("Erro ao atualizar funcion치rio:", erro));
        };
        td3.appendChild(btnAtualizar);

        // 游댳 Bot칚o Excluir
        const btnExcluir = document.createElement("button");
        btnExcluir.textContent = "Excluir";
        btnExcluir.onclick = () => delete_funcionario(funcionario.idFuncionario);
        td4.appendChild(btnExcluir);

        // 游댳 Bot칚o Alterar Senha (mant칠m o modal)
        const btnAlterarSenha = document.createElement("button");
        btnAlterarSenha.textContent = "Alterar Senha";
        btnAlterarSenha.onclick = () => abrirModalSenha(funcionario.idFuncionario);
        td5.appendChild(btnAlterarSenha);

        linha.append(td0, td1, td2, td3, td4, td5);
        tabela.appendChild(linha);
      }
    }

    function post_funcionarios() {
      const URI = "http://localhost:5050/funcionario/";
      const emailFuncionario = txtEmailFuncionario.value;
      const senhaFuncionario = txtSenhaFuncionario.value;

      const corpo = {
        "funcionario": {
          "emailFuncionario": emailFuncionario,
          "senhaFuncionario": senhaFuncionario
        }
      };

      fetch(URI, {
        method: "POST",
        body: JSON.stringify(corpo),
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + objUsuario.token
        }
      }).then((resposta) => {
        return resposta.text();
      }).then(respostaConvertida => {
        get_funcionarios();  // Atualiza a tabela ap칩s adicionar
        console.log(respostaConvertida);
        const objResposta = JSON.parse(respostaConvertida);
        if (objResposta.status == false) {
          alert(objResposta.msg);
        }
      }).catch(erro => {
        console.log(erro);
      });
    }

    function get_funcionarios() {
      const URI = "http://localhost:5050/funcionario/";
      fetch(URI, {
        method: "GET",
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + objUsuario.token
        }
      }).then((resposta) => {
        return resposta.text();
      }).then(respostaConvertida => {
        JSON_FUNCIONARIOS = JSON.parse(respostaConvertida).funcionarios;
        construirTabela(JSON_FUNCIONARIOS, null);
      }).catch(erro => {
        console.log(erro);
      });
    }

    function alterarSenha(idFuncionario) {
      const senhaAtual = prompt("Digite sua senha atual:");
      const novaSenha = prompt("Digite sua nova senha:");

      if (!senhaAtual || !novaSenha) {
        alert("As senhas n칚o podem ficar vazias!");
        return;
      }

      const corpo = {
        senhaAtual: senhaAtual,
        novaSenha: novaSenha
      };

      const URI = "http://localhost:5050/funcionario/" + idFuncionario + "/senha";

      fetch(URI, {
        method: "PUT",
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + objUsuario.token
        },
        body: JSON.stringify(corpo)
      })
      .then(res => res.json())
      .then(dados => {
        alert(dados.msg);
      })
      .catch(err => console.error("Erro ao alterar senha:", err));
    }

    // ===== MODAL DE ALTERA칂츾O DE SENHA =====
    const modal = document.getElementById("modalAlterarSenha");
    const btnConfirmar = document.getElementById("btnConfirmarSenha");
    const btnCancelar = document.getElementById("btnCancelarSenha");
    let funcionarioAtual = null;

    function abrirModalSenha(idFuncionario) {
      funcionarioAtual = idFuncionario;
      modal.style.display = "flex";
    }

    btnCancelar.onclick = function () {
      modal.style.display = "none";
      limparCamposModal();
    };

    btnConfirmar.onclick = function () {
      const senhaAtual = document.getElementById("senhaAtual").value;
      const novaSenha = document.getElementById("novaSenha").value;

      if (!senhaAtual || !novaSenha) {
        alert("Preencha todos os campos!");
        return;
      }

      const corpo = {
        senhaAtual: senhaAtual,
        novaSenha: novaSenha
      };

      const URI = "http://localhost:5050/funcionario/" + funcionarioAtual + "/senha";

      fetch(URI, {
        method: "PUT",
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + objUsuario.token
        },
        body: JSON.stringify(corpo)
      })
      .then(res => res.json())
      .then(dados => {
        alert(dados.msg);
        modal.style.display = "none";
        limparCamposModal();
      })
      .catch(err => {
        console.error("Erro ao alterar senha:", err);
        alert("Erro ao alterar senha!");
      });
    };

    function limparCamposModal() {
      document.getElementById("senhaAtual").value = "";
      document.getElementById("novaSenha").value = "";
    }
  </script>
</body>

</html>
